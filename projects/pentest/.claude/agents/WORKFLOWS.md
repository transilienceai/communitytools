# Agent Workflows

Complete workflow documentation with planning & approval phases.

## Design Principle

**Orchestrators plan → Get approval → Execute**. Never deploy testing agents without user approval.

## Pentester Orchestrator

```
Phase 1: Init → Phase 2: Recon → Phase 3: Plan & Approve ⚠️ → Phase 4: Test → Phase 5-6: Aggregate & Report
```

**Phase 3 (MANDATORY)**:
1. Analyze recon findings
2. Create test plan: proposed executors + justifications
3. Present via AskUserQuestion: "Approve?", "Modify?", "Cancel?"
4. Log: `{"phase":"planning","action":"user-approval","result":"approved"}`
5. Wait for approval before Phase 4

**Example Plan**:
```markdown
## Reconnaissance Findings
- Login form, API endpoints, file upload, admin panel

## Proposed Executors (15)
- SQL Injection → login form, API
- XSS → all inputs
- File Upload → upload endpoint
- [... 12 more based on attack surface]

## Approach
Deploy 15 executors in parallel, monitor 2-4 hours
```

## HackerOne Hunter

```
Phase 1: Parse Scope → Phase 2: Plan & Approve ⚠️ → Phase 3: Test Assets → Phase 4-5: Validate & Generate → Phase 6: Review ⚠️
```

**Phase 2 (MANDATORY)**:
1. Analyze scope: in-scope vs out-of-scope assets
2. Create plan: which assets to test, orchestrators to deploy
3. Present via AskUserQuestion
4. Wait for approval before Phase 3

**Phase 6 (MANDATORY)**:
1. Present generated submissions
2. Get approval before final submission

## Visual Workflow

**Single Asset**:
```
User Request
    ↓
Orchestrator: Init + Recon
    ↓
Orchestrator: Create Plan
    ↓
USER APPROVAL ⚠️ (AskUserQuestion)
    ↓ (approved)
Orchestrator: Deploy 15 Executors in Parallel
    ├─→ SQL Executor (4-phase: Recon → Experiment → Test → Verify)
    ├─→ XSS Executor (4-phase workflow)
    ├─→ SSRF Executor (4-phase workflow)
    └─→ ... (15 total)
    ↓
Orchestrator: Aggregate Findings
    ↓
pentest-report.json + reports
```

**Bug Bounty**:
```
User Provides Scope
    ↓
HackerOne: Parse Scope (15 assets, 12 in-scope)
    ↓
HackerOne: Create Plan
    ↓
USER APPROVAL ⚠️ (AskUserQuestion)
    ↓ (approved)
HackerOne: Deploy 12 Orchestrators in Parallel
    ├─→ Orchestrator (api.example.com) → 15 Executors → Findings
    ├─→ Orchestrator (www.example.com) → 20 Executors → Findings
    └─→ ... (12 total)
    ↓
HackerOne: Validate + Generate Submissions
    ↓
USER REVIEW ⚠️ (AskUserQuestion)
    ↓ (approved)
Submit to HackerOne
```

## AskUserQuestion Implementation

```python
AskUserQuestion(
    questions=[{
        "question": "Approve this penetration test plan?",
        "header": "Test Plan",
        "multiSelect": False,
        "options": [
            {"label": "Approve - proceed with testing (Recommended)", "description": "..."},
            {"label": "Modify executor list", "description": "..."},
            {"label": "Cancel testing", "description": "..."}
        ]
    }]
)
```

## Activity Logs

**Plan Creation**:
```json
{"timestamp":"...","agent":"pentester-orchestrator","phase":"planning","action":"create-plan","executors":15,"result":"plan-ready"}
```

**Approval**:
```json
{"timestamp":"...","agent":"pentester-orchestrator","phase":"planning","action":"user-approval","result":"approved"}
```

**Cancellation**:
```json
{"timestamp":"...","agent":"pentester-orchestrator","phase":"planning","action":"user-approval","result":"cancelled"}
{"timestamp":"...","agent":"pentester-orchestrator","phase":"complete","action":"engagement-cancelled","result":"user-requested"}
```

## Critical Rules

1. **ALWAYS** create test plan after reconnaissance
2. **ALWAYS** present plan via AskUserQuestion
3. **NEVER** deploy executors without approval
4. **ALWAYS** log plan creation and approval decision
5. If cancelled: Stop immediately
6. If modified: Iterate until approved

## Reference

- Complete plan template: `reference/TEST_PLAN_FORMAT.md`
- Output formats: `reference/OUTPUT_STRUCTURE.md`
- Agent definitions: `pentester-orchestrator.md`, `hackerone.md`
