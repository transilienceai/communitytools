# CSV Pentest Skill - Implementation Guide

## When This Skill Is Invoked

When the user runs `/pentest-csv <csv_file>`, you should:

1. **Parse the CSV file** to extract in-scope assets
2. **Collect program guidelines** (from user or provided arguments)
3. **Launch HackerOne Bug Bounty Hunter agent** with the scope and guidelines
4. **Monitor progress** and report results

## Step-by-Step Implementation

### Step 1: Parse Arguments

```python
# User command format:
# /pentest-csv <csv_file_path> [--guidelines "<text>"] [--guidelines-file <file>]

# Extract:
csv_file_path = args[0]  # Required
guidelines = args.get('--guidelines')  # Optional
guidelines_file = args.get('--guidelines-file')  # Optional
output_dir = args.get('--output', f'outputs/{program_name}')  # Optional
```

### Step 2: Read and Parse CSV

```python
# Read the CSV file using Read tool
csv_content = Read(csv_file_path)

# Parse the CSV to extract assets
# Look for columns: identifier, asset_type, eligible_for_submission, max_severity

# Example parsing:
import csv
assets = []
for row in csv.DictReader(csv_content.split('\n')):
    if row.get('eligible_for_submission') == 'true':
        assets.append({
            'identifier': row['identifier'],
            'asset_type': row['asset_type'],
            'max_severity': row.get('max_severity', 'critical'),
            'instruction': row.get('instruction', '')
        })
```

### Step 3: Collect Program Guidelines

If guidelines not provided in command:

```python
if not guidelines and not guidelines_file:
    # Ask user for guidelines
    guidelines = AskUserQuestion([{
        "question": "Please provide the bug bounty program guidelines:",
        "header": "Guidelines",
        "multiSelect": false,
        "options": [
            {
                "label": "Enter guidelines manually",
                "description": "Paste the program policy and rules"
            },
            {
                "label": "Load from file",
                "description": "Specify a file path"
            }
        ]
    }])
```

### Step 4: Extract Program Name

```python
# Extract program name from CSV filename
# Example: scopes_for_unico_idtech_at_2026-01-13.csv -> unico_idtech

import re
match = re.search(r'scopes_for_(.+?)(?:_at_|\.csv)', csv_file_path)
program_name = match.group(1) if match else 'unknown_program'
```

### Step 5: Create Output Directory Structure

```python
# Create directory structure
output_base = f'outputs/{program_name}'

Bash(f'''
mkdir -p {output_base}/{{reports/submissions,liveness,web_assets,findings}}
''')
```

### Step 6: Launch HackerOne Agent

```python
# Create comprehensive prompt for HackerOne agent
hackerone_prompt = f"""
Execute HackerOne bug bounty testing workflow:

**CSV Scope File**: {csv_file_path}
**Program Name**: {program_name}
**Total Assets**: {len(assets)}

**Program Guidelines**:
{guidelines}

**Assets to Test**:
{format_assets_list(assets)}

**Your Tasks**:
1. Read the CSV file: {csv_file_path}
2. Parse all {len(assets)} in-scope assets
3. Launch a Pentester agent for EACH asset in parallel using Task tool
4. Each Pentester agent should:
   - Test for vulnerabilities per program guidelines
   - Include required headers
   - Follow program rules and restrictions
   - Save findings to: {output_base}/[asset_name]/
5. Wait for all agents to complete
6. Aggregate findings from all agents
7. Generate HackerOne submission reports for each vulnerability found
8. Create comprehensive findings summary
9. Generate submission guide for HackerOne

**Output Location**: {output_base}/

**CRITICAL**: You MUST launch real Pentester agents using the Task tool, not just demonstrate the workflow.
"""

# Launch the HackerOne Bug Bounty Hunter agent
Task(
    description=f"HackerOne {program_name} bounty hunt",
    prompt=hackerone_prompt,
    subagent_type="HackerOne Bug Bounty Hunter",
    run_in_background=False  # Wait for completion to show results
)
```

### Step 7: Monitor and Report Progress

```python
# After launching agent, provide status updates to user
print(f"""
üöÄ Launched HackerOne Bug Bounty Hunt for {program_name}

üìã Scope:
   - {len(assets)} assets in scope
   - Output: {output_base}/

‚è≥ Estimated time: 2-4 hours (depends on asset count)

The HackerOne agent will:
1. Launch {len(assets)} Pentester agents in parallel
2. Test each asset for vulnerabilities
3. Generate HackerOne submission reports
4. Create findings summary and submission guide

üìä You can monitor progress with: /tasks

Results will be saved to: {output_base}/
""")
```

## Complete Implementation Template

Here's a complete implementation you should follow:

```python
async def execute_pentest_csv_skill(csv_file_path, **kwargs):
    """Execute the /pentest-csv skill"""

    # Step 1: Extract program name from CSV filename
    import re
    match = re.search(r'scopes_for_(.+?)(?:_at_|\.csv)', csv_file_path)
    program_name = match.group(1) if match else 'unknown_program'

    # Step 2: Read CSV file
    csv_content = await Read(csv_file_path)

    # Step 3: Parse assets
    import csv
    from io import StringIO

    assets = []
    reader = csv.DictReader(StringIO(csv_content))
    for row in reader:
        if row.get('eligible_for_submission', '').lower() == 'true':
            assets.append({
                'identifier': row['identifier'],
                'asset_type': row['asset_type'],
                'max_severity': row.get('max_severity', 'critical'),
                'instruction': row.get('instruction', ''),
                'eligible_for_bounty': row.get('eligible_for_bounty', 'true')
            })

    # Step 4: Get guidelines
    guidelines = kwargs.get('guidelines')
    if not guidelines:
        guidelines_file = kwargs.get('guidelines_file')
        if guidelines_file:
            guidelines = await Read(guidelines_file)
        else:
            # Ask user
            print("Please provide the bug bounty program guidelines:")
            print("Include: in-scope vulnerabilities, out-of-scope, testing rules, requirements")
            # User will provide via chat

    # Step 5: Create output directory
    output_base = f'outputs/{program_name}'
    await Bash(f'mkdir -p {output_base}/{{reports/submissions,liveness,web_assets,findings}}')

    # Step 6: Format assets list
    assets_formatted = '\n'.join([
        f"- {a['identifier']} ({a['asset_type']}) - Max Severity: {a['max_severity']}"
        for a in assets
    ])

    # Step 7: Create HackerOne agent prompt
    prompt = f"""
Execute HackerOne bug bounty testing workflow for {program_name}:

**CSV Scope File**: {csv_file_path}
**Total In-Scope Assets**: {len(assets)}

**Assets to Test**:
{assets_formatted}

**Program Guidelines**:
{guidelines}

**Execution Steps**:

1. **Read and parse** the CSV file at: {csv_file_path}

2. **For EACH of the {len(assets)} assets**, launch a Pentester agent using Task tool:
   ```python
   Task(
       description=f"Test {{asset_identifier}}",
       prompt='''
       Conduct comprehensive penetration testing on {{asset_identifier}}

       Program: {program_name} (HackerOne Private Bug Bounty)
       Asset Type: {{asset_type}}
       Max Severity: {{max_severity}}

       Program Guidelines:
       {guidelines}

       Test for all in-scope vulnerabilities per guidelines.
       Save findings to: {output_base}/{{asset_name}}/findings/
       ''',
       subagent_type="Pentester",
       run_in_background=True  # Run all in parallel
   )
   ```

3. **Wait for all {len(assets)} agents** to complete

4. **Aggregate findings** from all agents:
   - Read all findings from {output_base}/*/findings/
   - Deduplicate vulnerabilities
   - Prioritize by severity and bounty potential

5. **Generate HackerOne reports**:
   - Create individual report for each vulnerability
   - Format per HackerOne requirements
   - Include CVSS scores, reproduction steps, evidence
   - Save to: {output_base}/reports/submissions/

6. **Create summary documents**:
   - FINDINGS_SUMMARY.md with all vulnerabilities
   - HACKERONE_SUBMISSION_GUIDE.md with submission instructions
   - SCOPE_AND_GUIDELINES.md with program details

**Output Location**: {output_base}/

**CRITICAL**: Launch REAL Pentester agents, don't just demonstrate. Actually test the assets.
"""

    # Step 8: Launch HackerOne agent
    print(f"""
üöÄ Launching HackerOne Bug Bounty Hunt: {program_name}

üìã Scope:
   - {len(assets)} assets in CSV
   - Program: {program_name}
   - Output: {output_base}/

‚è≥ This will take 2-4 hours depending on asset count

The agent will:
‚úì Launch {len(assets)} Pentester agents in parallel
‚úì Test all in-scope vulnerabilities
‚úì Generate HackerOne submission reports
‚úì Create findings summary

Monitor with: /tasks
""")

    # Launch the agent
    await Task(
        description=f"HackerOne {program_name} bounty hunt",
        prompt=prompt,
        subagent_type="HackerOne Bug Bounty Hunter"
    )

    # Step 9: Report completion
    print(f"""
‚úÖ HackerOne Bug Bounty Hunt Complete!

üìÅ Results saved to: {output_base}/

üìä Check:
   - {output_base}/FINDINGS_SUMMARY.md - All vulnerabilities
   - {output_base}/reports/submissions/ - HackerOne reports
   - {output_base}/HACKERONE_SUBMISSION_GUIDE.md - How to submit

üéØ Next: Review reports and submit to HackerOne
""")
```

## Error Handling

Handle these common errors:

1. **CSV file not found**:
   ```python
   if not file_exists(csv_file_path):
       print(f"‚ùå Error: CSV file not found: {csv_file_path}")
       return
   ```

2. **No eligible assets**:
   ```python
   if len(assets) == 0:
       print(f"‚ùå Error: No eligible assets found in CSV (eligible_for_submission must be 'true')")
       return
   ```

3. **Missing guidelines**:
   ```python
   if not guidelines:
       print("‚ùå Error: Program guidelines required. Use --guidelines or --guidelines-file")
       return
   ```

## Summary

When `/pentest-csv` is invoked:

1. ‚úÖ Parse CSV file for assets
2. ‚úÖ Collect program guidelines
3. ‚úÖ Launch HackerOne Bug Bounty Hunter agent
4. ‚úÖ Agent launches Pentester agents for each asset
5. ‚úÖ Generate HackerOne submission reports
6. ‚úÖ Save to organized output directory

The key is to **actually launch the HackerOne agent** which will then **actually launch Pentester agents** for each asset, not just demonstrate the workflow.
