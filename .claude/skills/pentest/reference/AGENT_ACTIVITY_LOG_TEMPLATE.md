# Agent Activity Log Template

Simple template for pentest agents to record their actions.

## Quick Start

```python
import json
from datetime import datetime

class ActivityLogger:
    def __init__(self, agent_name, engagement_dir):
        self.agent_name = agent_name
        self.log_file = f"{engagement_dir}/activity/{agent_name}.log"

    def log(self, action, **kwargs):
        """Write action to activity log"""
        entry = {
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "agent": self.agent_name,
            "action": action,
            **kwargs
        }
        with open(self.log_file, 'a') as f:
            f.write(json.dumps(entry) + '\n')

# Usage in agent code
logger = ActivityLogger("sql-injection", "./outputs/engagement-123")
logger.log("start", target="https://example.com/search")
logger.log("test_payload", payload="' OR '1'='1", endpoint="/search?q=", result="vulnerable")
logger.log("verified_poc", finding_id="F-001", severity="critical")
logger.log("complete", findings=3, status="success")
```

## Standard Action Types

### `start`
Agent begins testing

```json
{"timestamp": "...", "agent": "sql-injection", "action": "start", "target": "https://example.com"}
```

### `test_payload`
Agent tests a specific payload

```json
{"timestamp": "...", "agent": "sql-injection", "action": "test_payload", "payload": "' OR '1'='1", "endpoint": "/search?q=", "result": "vulnerable"}
```

### `verified_poc`
Agent created and tested a working PoC

```json
{"timestamp": "...", "agent": "sql-injection", "action": "verified_poc", "finding_id": "F-001", "severity": "critical", "type": "SQL Injection"}
```

### `error`
Agent encountered an error

```json
{"timestamp": "...", "agent": "sql-injection", "action": "error", "message": "Connection timeout on endpoint /search"}
```

### `complete`
Agent finished testing

```json
{"timestamp": "...", "agent": "sql-injection", "action": "complete", "findings": 3, "status": "success"}
```

## Complete Agent Workflow Example

```python
def run_sql_injection_agent(target, engagement_dir):
    logger = ActivityLogger("sql-injection", engagement_dir)

    logger.log("start", target=target)

    # Find all parameters
    endpoints = discover_endpoints(target)

    for endpoint in endpoints:
        params = extract_parameters(endpoint)

        for param in params:
            # Test each parameter
            for payload in SQL_PAYLOADS:
                result = test_injection(target, endpoint, param, payload)
                logger.log("test_payload",
                          endpoint=endpoint,
                          param=param,
                          payload=payload,
                          result="vulnerable" if result else "safe")

                if result:
                    # Develop PoC
                    poc_code = develop_poc(target, endpoint, param, payload)
                    poc_output = execute_poc(poc_code)
                    finding_id = save_finding(poc_code, poc_output)

                    logger.log("verified_poc",
                              finding_id=finding_id,
                              severity="critical",
                              type="SQL Injection",
                              endpoint=endpoint)

    logger.log("complete", findings=len(findings), status="success")
```

## Activity Log Format Details

**One JSON object per line (NDJSON)**
- Each line is a complete, valid JSON object
- Parseable with `for line in file: json.loads(line)`
- Easy to aggregate and analyze

**Example multi-agent logs**:

```
{"timestamp": "14:23:15Z", "agent": "sql-injection", "action": "start", "target": "https://example.com"}
{"timestamp": "14:23:22Z", "agent": "sql-injection", "action": "test_payload", "result": "vulnerable"}
{"timestamp": "14:23:45Z", "agent": "sql-injection", "action": "verified_poc", "finding_id": "F-001"}
{"timestamp": "14:25:00Z", "agent": "sql-injection", "action": "complete", "findings": 3}
{"timestamp": "14:25:05Z", "agent": "xss", "action": "start", "target": "https://example.com"}
{"timestamp": "14:25:30Z", "agent": "xss", "action": "test_payload", "result": "vulnerable"}
{"timestamp": "14:26:00Z", "agent": "xss", "action": "verified_poc", "finding_id": "F-002"}
{"timestamp": "14:30:00Z", "agent": "xss", "action": "complete", "findings": 2}
```

## Reading Activity Logs

```python
import json

def read_activity_log(log_file):
    """Parse agent activity log"""
    with open(log_file, 'r') as f:
        for line in f:
            if line.strip():
                action = json.loads(line)
                print(f"{action['timestamp']} - {action['agent']}: {action['action']}")

# Output:
# 14:23:15Z - sql-injection: start
# 14:23:22Z - sql-injection: test_payload
# 14:23:45Z - sql-injection: verified_poc
# 14:25:00Z - sql-injection: complete
```

## Aggregating Multiple Agent Logs

```python
import json
import glob

def aggregate_activity_logs(activity_dir):
    """Read all activity logs and return sorted timeline"""
    all_actions = []

    for log_file in glob.glob(f"{activity_dir}/*.log"):
        with open(log_file, 'r') as f:
            for line in f:
                if line.strip():
                    all_actions.append(json.loads(line))

    # Sort by timestamp
    all_actions.sort(key=lambda x: x['timestamp'])

    return all_actions

# Use for debugging, auditing, or generating reports
actions = aggregate_activity_logs('./outputs/engagement-123/activity/')
for action in actions:
    if action['action'] == 'verified_poc':
        print(f"[{action['timestamp']}] Found {action['type']}: {action['finding_id']}")
```

## Integration with Pentester Coordinator

The pentester agent reads:
1. All activity logs → understand what agents did
2. findings.json → extract findings details
3. Creates pentest-report.json → summarize results

```python
# In pentester agent
def create_pentest_report(engagement_dir):
    activity_logs = aggregate_activity_logs(f"{engagement_dir}/activity/")
    findings = load_findings(f"{engagement_dir}/findings/findings.json")

    # Extract agent names from activity logs
    agents_run = list(set(a['agent'] for a in activity_logs))

    # Create report
    report = {
        "engagement": config.engagement,
        "generated": datetime.utcnow().isoformat() + "Z",
        "summary": summarize_by_severity(findings),
        "agents_run": agents_run,
        "findings": findings,
        "status": "complete"
    }

    with open(f"{engagement_dir}/pentest-report.json", 'w') as f:
        json.dump(report, f, indent=2)
```

---

**Keep it simple**: One log line per action, JSON format, parseable.
